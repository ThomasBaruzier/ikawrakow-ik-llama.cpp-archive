## ðŸ”€ [Pull Request #739](https://github.com/ikawrakow/ik_llama.cpp/pull/739) - CUDA: prompt processing optimizations for MoE models

| **Author** | `ikawrakow` |
| :--- | :--- |
| **State** | ðŸ”€ **Merged** |
| **Source Branch** | `ik/skip_rowids_computation` |
| **Target Branch** | `main` |
| **Created** | 2025-08-29 |
| **Updated** | 2025-08-30 |
| **Merged** | 2025-08-30 |

---

## ðŸ“„ Description

This PR adds additional PP optimizations for MoE models on CUDA:
* Don't repeat preparation of row ID's
* Better block size for smallish batch sizes

Not a major improvement, but quite significant for some batch sizes. Here 3 examples running fully offloaded to an RTX-4080

| model                | n_ubatch |          test |    t/s (main)    |    t/s (PR)      |  Speedup |
| -------------------- | -------: | ------------: | ---------------: | ---------------: | -------: |
| qwen3moe 30B IQ2_XXS |       32 |        pp4096 |   1288.84 Â± 4.70 |   1293.91 Â± 4.74 |  1.004   |   
| qwen3moe 30B IQ2_XXS |       64 |        pp4096 |  1920.23 Â± 16.74 |   2030.87 Â± 7.62 |  1.058   |   
| qwen3moe 30B IQ2_XXS |      128 |        pp4096 |  2493.96 Â± 23.17 |  2854.37 Â± 19.33 |  1.145   |   
| qwen3moe 30B IQ2_XXS |      256 |        pp4096 |  3954.87 Â± 37.19 |  4295.92 Â± 40.61 |  1.086   |   
| qwen3moe 30B IQ2_XXS |      512 |        pp4096 |  5541.13 Â± 59.37 |   5607.92 Â± 7.17 |  1.012   |   
| qwen3moe 30B IQ2_XXS |     1024 |        pp4096 |  6482.04 Â± 15.25 |  6489.29 Â± 78.17 |  1.001   |   
| qwen3moe 30B IQ2_XXS |     2048 |        pp4096 |  6553.18 Â± 14.51 | 6569.46 Â± 122.07 |  1.002   |   
| qwen3moe 30B IQ2_XXS |     4096 |        pp4096 |   6233.57 Â± 6.11 |   6264.04 Â± 7.99 |  1.005   |   

| model              | n_ubatch |          test |     t/s (main)   |     t/s (PR)     |  Speedup |
| ------------------ | -------: | ------------: | ---------------: | ---------------: | -------: |
| gpt-oss 20B MXFP4  |       32 |        pp3072 |  1829.59 Â± 14.08 |  1846.63 Â± 10.01 |  1.009   |   
| gpt-oss 20B MXFP4  |       64 |        pp3072 |  2718.86 Â± 14.46 |  2850.96 Â± 12.68 |  1.049   |   
| gpt-oss 20B MXFP4  |      128 |        pp3072 |  3605.42 Â± 22.74 |  4172.56 Â± 18.51 |  1.157   |   
| gpt-oss 20B MXFP4  |      256 |        pp3072 |  5585.75 Â± 23.18 |  5613.02 Â± 21.73 |  1.005   |   
| gpt-oss 20B MXFP4  |      512 |        pp3072 |  7515.52 Â± 29.98 |  7550.16 Â± 34.97 |  1.005   |   
| gpt-oss 20B MXFP4  |     1024 |        pp3072 |  8564.83 Â± 27.95 |  8607.61 Â± 26.29 |  1.005   |   
| gpt-oss 20B MXFP4  |     1536 |        pp3072 |  9842.09 Â± 43.56 |  9913.19 Â± 45.32 |  1.007   |   
| gpt-oss 20B MXFP4  |     3072 |        pp3072 | 10150.96 Â± 19.07 | 10233.19 Â± 24.86 |  1.008   |   

| model               | n_ubatch |          test |       t/s (main)  |       t/s (PR)    |  Speedup |
| ------------------- | -------: | ------------: | ----------------: | ----------------: | -------: |
| deepseek2 16B Q4_0  |       32 |        pp4096 |    935.59 Â± 7.12  |  1317.92 Â± 17.30  |  1.409   |   
| deepseek2 16B Q4_0  |       64 |        pp4096 |   1536.07 Â± 3.37  |   2312.58 Â± 6.17  |  1.506   |   
| deepseek2 16B Q4_0  |      128 |        pp4096 |  3045.47 Â± 48.22  |  3637.98 Â± 11.88  |  1.195   |   
| deepseek2 16B Q4_0  |      256 |        pp4096 |  5163.37 Â± 58.35  |  5578.81 Â± 33.57  |  1.080   |   
| deepseek2 16B Q4_0  |      512 |        pp4096 |  7573.41 Â± 55.78  |  7919.14 Â± 62.49  |  1.046   |   
| deepseek2 16B Q4_0  |     1024 |        pp4096 | 9661.28 Â± 104.69  | 9732.25 Â± 102.30  |  1.007   |   
| deepseek2 16B Q4_0  |     2048 |        pp4096 | 10369.55 Â± 106.44 | 10432.49 Â± 107.87 |  1.006   |   
| deepseek2 16B Q4_0  |     4096 |        pp4096 | 10235.64 Â± 30.57  | 10374.08 Â± 18.66  |  1.014   |

---

## ðŸ’¬ Conversation

ðŸ‘¤ **ubergarm** commented on **2025-08-29** at **17:48:35**

Did some sweep-bench for fully GPU offloaded GLM-4.5-Air Q8_0/Q4_0 mix. I don't see a big difference between PR739 and main here on ik_llama.cpp checking only default batches e.g. implicit `-ub 512 -b 2048` and `-ub 4096 -b 4096`. Roughly 1% speed-up for this PR over main at default batches and within the noise for `-ub 4096 -b 4096`.

Thought interestingly ik_llama.cpp is looking very performant relative to mainline currently for this configuration. I couldn't get mainline to run with `-ub 4096 -b 4096` as it kept OOMing trying to allocate a very large CUDA buffer and crashed even at small context size test attempts `ggml_backend_cuda_buffer_type_alloc_buffer: allocating 50272.05 MiB on device 0: cudaMalloc failed: out of memory`

I did a very quick spot check at `-ub 64` and this PR is indeed roughly 18% faster than main branch and 22% faster than mainline lcpp. I rarely ever use that small of ubatch size in pratice, but this PR does seem to be working.

<img width="2087" height="1111" alt="sweep-bench-PR739" src="https://github.com/user-attachments/assets/1f8de574-9dfe-4746-88c1-ba19d4060932" />


<details>

<summary>ðŸ‘ˆ Details</summary>

```bash
./build/bin/llama-sweep-bench \
    --model "$model"\
    -fa -fmoe \
    -c 36864 \
    -ngl 99 \
    --threads 1 \
    --warmup-batch
    #-ub 4096 -b 4096 \
```

## main@46968d4a default batches
|    PP |     TG |   N_KV |   T_PP s | S_PP t/s |   T_TG s | S_TG t/s |
|-------|--------|--------|----------|----------|----------|----------|
|   512 |    128 |      0 |    0.427 |  1199.49 |    2.536 |    50.47 |
|   512 |    128 |    512 |    0.429 |  1193.46 |    2.547 |    50.25 |
|   512 |    128 |   1024 |    0.438 |  1168.56 |    2.565 |    49.90 |
|   512 |    128 |   1536 |    0.449 |  1140.80 |    2.581 |    49.59 |
|   512 |    128 |   2048 |    0.456 |  1122.65 |    2.654 |    48.23 |
|   512 |    128 |   2560 |    0.466 |  1098.38 |    2.661 |    48.11 |
|   512 |    128 |   3072 |    0.474 |  1079.59 |    2.666 |    48.00 |
|   512 |    128 |   3584 |    0.486 |  1053.92 |    2.743 |    46.67 |
|   512 |    128 |   4096 |    0.491 |  1043.60 |    2.748 |    46.58 |
|   512 |    128 |   4608 |    0.503 |  1017.51 |    2.751 |    46.53 |
|   512 |    128 |   5120 |    0.511 |  1002.05 |    2.762 |    46.35 |
|   512 |    128 |   5632 |    0.520 |   984.63 |    2.837 |    45.11 |
|   512 |    128 |   6144 |    0.528 |   969.97 |    2.849 |    44.93 |
|   512 |    128 |   6656 |    0.535 |   957.23 |    2.851 |    44.90 |
|   512 |    128 |   7168 |    0.544 |   940.76 |    2.927 |    43.74 |
|   512 |    128 |   7680 |    0.551 |   929.52 |    2.932 |    43.66 |
|   512 |    128 |   8192 |    0.562 |   910.98 |    2.934 |    43.62 |
|   512 |    128 |   8704 |    0.566 |   904.95 |    2.950 |    43.39 |
|   512 |    128 |   9216 |    0.579 |   883.86 |    3.014 |    42.46 |
|   512 |    128 |   9728 |    0.592 |   865.36 |    3.029 |    42.26 |
|   512 |    128 |  10240 |    0.601 |   851.89 |    3.032 |    42.22 |
|   512 |    128 |  10752 |    0.606 |   845.33 |    3.099 |    41.31 |
|   512 |    128 |  11264 |    0.616 |   830.58 |    3.112 |    41.13 |
|   512 |    128 |  11776 |    0.627 |   816.87 |    3.114 |    41.11 |
|   512 |    128 |  12288 |    0.632 |   810.37 |    3.123 |    40.99 |
|   512 |    128 |  12800 |    0.642 |   797.17 |    3.192 |    40.11 |
|   512 |    128 |  13312 |    0.656 |   781.01 |    3.204 |    39.95 |
|   512 |    128 |  13824 |    0.663 |   772.83 |    3.206 |    39.93 |
|   512 |    128 |  14336 |    0.675 |   758.29 |    3.273 |    39.10 |
|   512 |    128 |  14848 |    0.680 |   753.30 |    3.287 |    38.94 |
|   512 |    128 |  15360 |    0.692 |   739.61 |    3.294 |    38.86 |
|   512 |    128 |  15872 |    0.701 |   730.04 |    3.303 |    38.75 |
|   512 |    128 |  16384 |    0.708 |   723.54 |    3.369 |    37.99 |
|   512 |    128 |  16896 |    0.723 |   708.00 |    3.380 |    37.87 |
|   512 |    128 |  17408 |    0.733 |   698.71 |    3.381 |    37.86 |
|   512 |    128 |  17920 |    0.740 |   692.04 |    3.443 |    37.17 |
|   512 |    128 |  18432 |    0.750 |   682.38 |    3.458 |    37.02 |
|   512 |    128 |  18944 |    0.758 |   675.19 |    3.469 |    36.89 |
|   512 |    128 |  19456 |    0.767 |   667.63 |    3.481 |    36.78 |
|   512 |    128 |  19968 |    0.780 |   656.39 |    3.545 |    36.11 |
|   512 |    128 |  20480 |    0.787 |   650.53 |    3.555 |    36.01 |
|   512 |    128 |  20992 |    0.797 |   642.38 |    3.564 |    35.92 |
|   512 |    128 |  21504 |    0.807 |   634.31 |    3.624 |    35.32 |
|   512 |    128 |  22016 |    0.817 |   626.83 |    3.640 |    35.16 |
|   512 |    128 |  22528 |    0.822 |   622.58 |    3.650 |    35.07 |
|   512 |    128 |  23040 |    0.833 |   614.80 |    3.665 |    34.93 |
|   512 |    128 |  23552 |    0.846 |   605.00 |    3.727 |    34.34 |
|   512 |    128 |  24064 |    0.853 |   599.91 |    3.736 |    34.26 |
|   512 |    128 |  24576 |    0.864 |   592.55 |    3.742 |    34.20 |
|   512 |    128 |  25088 |    0.869 |   589.13 |    3.804 |    33.65 |
|   512 |    128 |  25600 |    0.879 |   582.24 |    3.820 |    33.51 |
|   512 |    128 |  26112 |    0.888 |   576.79 |    3.843 |    33.30 |
|   512 |    128 |  26624 |    0.897 |   570.59 |    3.848 |    33.27 |
|   512 |    128 |  27136 |    0.909 |   563.42 |    3.916 |    32.68 |
|   512 |    128 |  27648 |    0.915 |   559.83 |    3.924 |    32.62 |
|   512 |    128 |  28160 |    0.924 |   554.20 |    3.933 |    32.55 |
|   512 |    128 |  28672 |    0.935 |   547.85 |    3.988 |    32.09 |
|   512 |    128 |  29184 |    0.942 |   543.27 |    4.012 |    31.90 |
|   512 |    128 |  29696 |    0.949 |   539.55 |    4.020 |    31.84 |
|   512 |    128 |  30208 |    0.958 |   534.39 |    4.029 |    31.77 |
|   512 |    128 |  30720 |    0.968 |   529.02 |    4.098 |    31.23 |
|   512 |    128 |  31232 |    0.979 |   523.05 |    4.110 |    31.15 |
|   512 |    128 |  31744 |    0.987 |   518.61 |    4.112 |    31.13 |
|   512 |    128 |  32256 |    1.000 |   512.17 |    4.167 |    30.72 |
|   512 |    128 |  32768 |    1.006 |   508.78 |    4.188 |    30.57 |
|   512 |    128 |  33280 |    1.014 |   504.95 |    4.202 |    30.46 |
|   512 |    128 |  33792 |    1.023 |   500.52 |    4.210 |    30.40 |
|   512 |    128 |  34304 |    1.029 |   497.41 |    4.278 |    29.92 |
|   512 |    128 |  34816 |    1.037 |   493.67 |    4.288 |    29.85 |
|   512 |    128 |  35328 |    1.051 |   486.95 |    4.301 |    29.76 |
|   512 |    128 |  35840 |    1.057 |   484.39 |    4.346 |    29.45 |
|   512 |    128 |  36352 |    1.069 |   478.79 |    4.371 |    29.28 |

## main@46968d4a -ub 4096 -b 4096
|    PP |     TG |   N_KV |   T_PP s | S_PP t/s |   T_TG s | S_TG t/s |
|-------|--------|--------|----------|----------|----------|----------|
|  4096 |   1024 |      0 |    2.456 |  1667.51 |   20.342 |    50.34 |
|  4096 |   1024 |   4096 |    2.993 |  1368.46 |   21.930 |    46.69 |
|  4096 |   1024 |   8192 |    3.630 |  1128.37 |   23.584 |    43.42 |
|  4096 |   1024 |  12288 |    4.249 |   964.01 |   25.335 |    40.42 |
|  4096 |   1024 |  16384 |    4.814 |   850.89 |   26.963 |    37.98 |
|  4096 |   1024 |  20480 |    5.388 |   760.27 |   28.455 |    35.99 |
|  4096 |   1024 |  24576 |    5.951 |   688.31 |   30.184 |    33.93 |
|  4096 |   1024 |  28672 |    7.802 |   525.01 |   31.961 |    32.04 |
|  4096 |   1024 |  32768 |    8.291 |   494.02 |   33.391 |    30.67 |

## PR739 ik/skip_rowids_computation@b0a1c632 default batches
|    PP |     TG |   N_KV |   T_PP s | S_PP t/s |   T_TG s | S_TG t/s |
|-------|--------|--------|----------|----------|----------|----------|
|   512 |    128 |      0 |    0.422 |  1214.38 |    2.536 |    50.47 |
|   512 |    128 |    512 |    0.425 |  1204.79 |    2.551 |    50.18 |
|   512 |    128 |   1024 |    0.437 |  1170.56 |    2.564 |    49.92 |
|   512 |    128 |   1536 |    0.445 |  1149.64 |    2.580 |    49.61 |
|   512 |    128 |   2048 |    0.450 |  1137.78 |    2.650 |    48.30 |
|   512 |    128 |   2560 |    0.461 |  1111.69 |    2.655 |    48.21 |
|   512 |    128 |   3072 |    0.466 |  1099.80 |    2.656 |    48.18 |
|   512 |    128 |   3584 |    0.476 |  1075.99 |    2.731 |    46.86 |
|   512 |    128 |   4096 |    0.484 |  1057.59 |    2.736 |    46.78 |
|   512 |    128 |   4608 |    0.494 |  1036.96 |    2.740 |    46.72 |
|   512 |    128 |   5120 |    0.503 |  1017.52 |    2.753 |    46.49 |
|   512 |    128 |   5632 |    0.511 |  1002.87 |    2.824 |    45.33 |
|   512 |    128 |   6144 |    0.518 |   987.53 |    2.834 |    45.17 |
|   512 |    128 |   6656 |    0.526 |   974.21 |    2.837 |    45.12 |
|   512 |    128 |   7168 |    0.534 |   958.90 |    2.910 |    43.99 |
|   512 |    128 |   7680 |    0.545 |   939.77 |    2.925 |    43.77 |
|   512 |    128 |   8192 |    0.552 |   928.38 |    2.928 |    43.72 |
|   512 |    128 |   8704 |    0.561 |   913.16 |    2.940 |    43.54 |
|   512 |    128 |   9216 |    0.571 |   896.60 |    3.006 |    42.58 |
|   512 |    128 |   9728 |    0.582 |   880.23 |    3.021 |    42.37 |
|   512 |    128 |  10240 |    0.591 |   865.81 |    3.021 |    42.36 |
|   512 |    128 |  10752 |    0.598 |   856.89 |    3.090 |    41.42 |
|   512 |    128 |  11264 |    0.607 |   843.70 |    3.106 |    41.20 |
|   512 |    128 |  11776 |    0.614 |   833.29 |    3.109 |    41.17 |
|   512 |    128 |  12288 |    0.626 |   817.30 |    3.117 |    41.06 |
|   512 |    128 |  12800 |    0.635 |   806.23 |    3.186 |    40.18 |
|   512 |    128 |  13312 |    0.648 |   789.85 |    3.200 |    40.00 |
|   512 |    128 |  13824 |    0.656 |   780.45 |    3.203 |    39.96 |
|   512 |    128 |  14336 |    0.670 |   764.65 |    3.270 |    39.14 |
|   512 |    128 |  14848 |    0.676 |   757.62 |    3.286 |    38.96 |
|   512 |    128 |  15360 |    0.688 |   744.30 |    3.288 |    38.92 |
|   512 |    128 |  15872 |    0.698 |   733.80 |    3.300 |    38.78 |
|   512 |    128 |  16384 |    0.706 |   725.61 |    3.367 |    38.01 |
|   512 |    128 |  16896 |    0.718 |   712.77 |    3.378 |    37.89 |
|   512 |    128 |  17408 |    0.729 |   702.21 |    3.380 |    37.87 |
|   512 |    128 |  17920 |    0.731 |   700.76 |    3.444 |    37.17 |
|   512 |    128 |  18432 |    0.746 |   686.56 |    3.457 |    37.03 |
|   512 |    128 |  18944 |    0.756 |   677.04 |    3.467 |    36.92 |
|   512 |    128 |  19456 |    0.765 |   669.67 |    3.478 |    36.80 |
|   512 |    128 |  19968 |    0.777 |   658.54 |    3.542 |    36.13 |
|   512 |    128 |  20480 |    0.784 |   653.04 |    3.553 |    36.02 |
|   512 |    128 |  20992 |    0.792 |   646.39 |    3.558 |    35.97 |
|   512 |    128 |  21504 |    0.800 |   639.96 |    3.624 |    35.32 |
|   512 |    128 |  22016 |    0.810 |   632.48 |    3.643 |    35.14 |
|   512 |    128 |  22528 |    0.819 |   625.09 |    3.648 |    35.09 |
|   512 |    128 |  23040 |    0.828 |   618.52 |    3.659 |    34.99 |
|   512 |    128 |  23552 |    0.839 |   610.38 |    3.723 |    34.38 |
|   512 |    128 |  24064 |    0.848 |   603.67 |    3.732 |    34.30 |
|   512 |    128 |  24576 |    0.856 |   598.48 |    3.739 |    34.24 |
|   512 |    128 |  25088 |    0.866 |   591.19 |    3.803 |    33.66 |
|   512 |    128 |  25600 |    0.876 |   584.77 |    3.817 |    33.53 |
|   512 |    128 |  26112 |    0.883 |   579.68 |    3.831 |    33.41 |
|   512 |    128 |  26624 |    0.896 |   571.58 |    3.848 |    33.27 |
|   512 |    128 |  27136 |    0.904 |   566.14 |    3.916 |    32.69 |
|   512 |    128 |  27648 |    0.913 |   561.09 |    3.922 |    32.63 |
|   512 |    128 |  28160 |    0.923 |   554.49 |    3.929 |    32.58 |
|   512 |    128 |  28672 |    0.935 |   547.44 |    3.987 |    32.10 |
|   512 |    128 |  29184 |    0.943 |   542.99 |    4.006 |    31.95 |
|   512 |    128 |  29696 |    0.950 |   538.77 |    4.014 |    31.89 |
|   512 |    128 |  30208 |    0.957 |   535.10 |    4.024 |    31.81 |
|   512 |    128 |  30720 |    0.965 |   530.59 |    4.094 |    31.27 |
|   512 |    128 |  31232 |    0.977 |   524.08 |    4.105 |    31.18 |
|   512 |    128 |  31744 |    0.988 |   518.46 |    4.116 |    31.10 |
|   512 |    128 |  32256 |    0.993 |   515.42 |    4.166 |    30.72 |
|   512 |    128 |  32768 |    1.002 |   511.04 |    4.183 |    30.60 |
|   512 |    128 |  33280 |    1.009 |   507.67 |    4.199 |    30.48 |
|   512 |    128 |  33792 |    1.019 |   502.48 |    4.204 |    30.45 |
|   512 |    128 |  34304 |    1.031 |   496.69 |    4.274 |    29.95 |
|   512 |    128 |  34816 |    1.038 |   493.32 |    4.284 |    29.88 |
|   512 |    128 |  35328 |    1.046 |   489.38 |    4.294 |    29.81 |
|   512 |    128 |  35840 |    1.055 |   485.48 |    4.344 |    29.46 |
|   512 |    128 |  36352 |    1.066 |   480.27 |    4.367 |    29.31 |

## PR739 ik/skip_rowids_computation@b0a1c632 -ub 4096 -b 4096
|    PP |     TG |   N_KV |   T_PP s | S_PP t/s |   T_TG s | S_TG t/s |
|-------|--------|--------|----------|----------|----------|----------|
|  4096 |   1024 |      0 |    2.505 |  1634.83 |   20.399 |    50.20 |
|  4096 |   1024 |   4096 |    3.048 |  1343.96 |   22.033 |    46.48 |
|  4096 |   1024 |   8192 |    3.667 |  1117.10 |   23.673 |    43.26 |
|  4096 |   1024 |  12288 |    4.283 |   956.34 |   25.378 |    40.35 |
|  4096 |   1024 |  16384 |    4.839 |   846.42 |   26.973 |    37.96 |
|  4096 |   1024 |  20480 |    5.401 |   758.41 |   28.467 |    35.97 |
|  4096 |   1024 |  24576 |    5.953 |   688.02 |   30.190 |    33.92 |
|  4096 |   1024 |  28672 |    7.799 |   525.20 |   31.957 |    32.04 |
|  4096 |   1024 |  32768 |    8.286 |   494.34 |   33.360 |    30.70 |

# mainline llama.cpp/master@8101786 + ug/port-sweep-bench default batches
|    PP |     TG |   N_KV |   T_PP s | S_PP t/s |   T_TG s | S_TG t/s |
|-------|--------|--------|----------|----------|----------|----------|
|   512 |    128 |      0 |    0.485 |  1054.84 |    2.558 |    50.04 |
|   512 |    128 |    512 |    0.547 |   936.23 |    2.678 |    47.80 |
|   512 |    128 |   1024 |    0.592 |   864.73 |    2.769 |    46.23 |
|   512 |    128 |   1536 |    0.616 |   831.68 |    2.896 |    44.19 |
|   512 |    128 |   2048 |    0.668 |   766.26 |    2.932 |    43.66 |
|   512 |    128 |   2560 |    0.700 |   731.61 |    3.022 |    42.36 |
|   512 |    128 |   3072 |    0.771 |   664.38 |    3.116 |    41.08 |
|   512 |    128 |   3584 |    0.785 |   651.91 |    3.222 |    39.72 |
|   512 |    128 |   4096 |    0.862 |   594.28 |    3.306 |    38.72 |
|   512 |    128 |   4608 |    0.893 |   573.14 |    3.395 |    37.70 |
|   512 |    128 |   5120 |    0.943 |   542.87 |    3.495 |    36.62 |
|   512 |    128 |   5632 |    0.974 |   525.69 |    3.592 |    35.64 |
|   512 |    128 |   6144 |    1.032 |   495.89 |    3.687 |    34.72 |
|   512 |    128 |   6656 |    1.068 |   479.43 |    3.785 |    33.82 |
|   512 |    128 |   7168 |    1.125 |   455.31 |    3.892 |    32.89 |
|   512 |    128 |   7680 |    1.166 |   439.07 |    3.994 |    32.05 |
|   512 |    128 |   8192 |    1.218 |   420.47 |    4.074 |    31.42 |
|   512 |    128 |   8704 |    1.262 |   405.85 |    4.166 |    30.73 |
|   512 |    128 |   9216 |    1.306 |   392.19 |    4.264 |    30.02 |
|   512 |    128 |   9728 |    1.349 |   379.57 |    4.353 |    29.40 |
|   512 |    128 |  10240 |    1.406 |   364.07 |    4.444 |    28.80 |
|   512 |    128 |  10752 |    1.449 |   353.42 |    4.543 |    28.17 |
|   512 |    128 |  11264 |    1.506 |   340.00 |    4.646 |    27.55 |
|   512 |    128 |  11776 |    1.558 |   328.54 |    4.732 |    27.05 |
|   512 |    128 |  12288 |    1.610 |   318.07 |    4.802 |    26.65 |
|   512 |    128 |  12800 |    1.664 |   307.76 |    4.902 |    26.11 |
|   512 |    128 |  13312 |    1.712 |   299.03 |    4.994 |    25.63 |
|   512 |    128 |  13824 |    1.758 |   291.27 |    5.101 |    25.09 |
|   512 |    128 |  14336 |    1.816 |   281.94 |    5.185 |    24.69 |
|   512 |    128 |  14848 |    1.855 |   275.97 |    5.277 |    24.26 |
|   512 |    128 |  15360 |    1.911 |   267.89 |    5.385 |    23.77 |
|   512 |    128 |  15872 |    1.954 |   262.08 |    5.491 |    23.31 |
|   512 |    128 |  16384 |    2.009 |   254.87 |    5.568 |    22.99 |
|   512 |    128 |  16896 |    2.056 |   249.03 |    5.660 |    22.61 |
|   512 |    128 |  17408 |    2.108 |   242.90 |    5.763 |    22.21 |
|   512 |    128 |  17920 |    2.153 |   237.76 |    5.897 |    21.71 |
|   512 |    128 |  18432 |    2.207 |   231.99 |    5.984 |    21.39 |
|   512 |    128 |  18944 |    2.243 |   228.26 |    6.104 |    20.97 |
|   512 |    128 |  19456 |    2.306 |   222.00 |    6.227 |    20.56 |
|   512 |    128 |  19968 |    2.348 |   218.08 |    6.356 |    20.14 |
|   512 |    128 |  20480 |    2.396 |   213.72 |    6.430 |    19.91 |
|   512 |    128 |  20992 |    2.437 |   210.07 |    6.558 |    19.52 |
|   512 |    128 |  21504 |    2.489 |   205.74 |    6.690 |    19.13 |
|   512 |    128 |  22016 |    2.540 |   201.57 |    6.855 |    18.67 |
|   512 |    128 |  22528 |    2.579 |   198.49 |    6.955 |    18.40 |
|   512 |    128 |  23040 |    2.627 |   194.88 |    7.102 |    18.02 |
|   512 |    128 |  23552 |    2.675 |   191.42 |    7.273 |    17.60 |
|   512 |    128 |  24064 |    2.784 |   183.93 |    7.483 |    17.11 |
|   512 |    128 |  24576 |    2.795 |   183.21 |    7.667 |    16.69 |
|   512 |    128 |  25088 |    3.360 |   152.39 |    7.839 |    16.33 |
|   512 |    128 |  25600 |    3.460 |   147.98 |    8.313 |    15.40 |
|   512 |    128 |  26112 |    3.565 |   143.63 |    8.665 |    14.77 |
|   512 |    128 |  26624 |    3.658 |   139.98 |    9.034 |    14.17 |
|   512 |    128 |  27136 |    3.757 |   136.26 |    9.412 |    13.60 |
|   512 |    128 |  27648 |    3.860 |   132.65 |    9.878 |    12.96 |
|   512 |    128 |  28160 |    3.956 |   129.41 |   10.251 |    12.49 |
|   512 |    128 |  28672 |    4.058 |   126.19 |   10.603 |    12.07 |
|   512 |    128 |  29184 |    4.157 |   123.17 |   11.044 |    11.59 |
|   512 |    128 |  29696 |    4.263 |   120.11 |   11.356 |    11.27 |
|   512 |    128 |  30208 |    4.386 |   116.73 |   11.746 |    10.90 |
|   512 |    128 |  30720 |    4.509 |   113.55 |   11.897 |    10.76 |
|   512 |    128 |  31232 |    4.629 |   110.62 |   12.297 |    10.41 |
|   512 |    128 |  31744 |    4.745 |   107.91 |   12.563 |    10.19 |
|   512 |    128 |  32256 |    4.854 |   105.49 |   12.901 |     9.92 |
|   512 |    128 |  32768 |    4.982 |   102.78 |   13.197 |     9.70 |
|   512 |    128 |  33280 |    5.089 |   100.61 |   13.596 |     9.41 |
|   512 |    128 |  33792 |    5.198 |    98.50 |   13.751 |     9.31 |
|   512 |    128 |  34304 |    5.315 |    96.33 |   14.222 |     9.00 |
|   512 |    128 |  34816 |    5.418 |    94.50 |   14.456 |     8.85 |
|   512 |    128 |  35328 |    5.519 |    92.77 |   14.833 |     8.63 |
|   512 |    128 |  35840 |    5.620 |    91.10 |   15.134 |     8.46 |
|   512 |    128 |  36352 |    5.736 |    89.26 |   15.368 |     8.33 |

# mainline llama.cpp/master@8101786 + ug/port-sweep-bench -ub 4096 -b 4096 OOMs
no data, it always OOMs trying to allocate a way too big CUDA buffer for some reason?

</details>

---

ðŸ‘¤ **ikawrakow** commented on **2025-08-30** at **06:39:25**

>  I rarely ever use that small of ubatch size in pratice, but this PR does seem to be working.

I agree, such small sizes are not very useful in practice. But I thought let's still have it so we don't get told how mainline is faster than `ik_llama.cpp` for small u-batch sizes. There are also people who get excited about time-to-first-token being 40 instead of 50 ms after a short prompt.