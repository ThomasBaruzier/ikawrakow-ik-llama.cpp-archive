## ðŸ”€ [Pull Request #754](https://github.com/ikawrakow/ik_llama.cpp/pull/754) - Alternative CUDA FA for SWA models

| **Author** | `ikawrakow` |
| :--- | :--- |
| **State** | ðŸ”€ **Merged** |
| **Source Branch** | `ik/cuda_swa3` |
| **Target Branch** | `main` |
| **Created** | 2025-09-03 |
| **Updated** | 2025-09-04 |
| **Merged** | 2025-09-04 |

---

## ðŸ“„ Description

This PR is an alternative to [#752](https://github.com/ikawrakow/ik_llama.cpp/issues/752) that differs only for TG compute graphs. On my RTX-4080 it achieves a tiny bit better TG performance than [#752](https://github.com/ikawrakow/ik_llama.cpp/issues/752). 

Curious to see comparisons between [#752](https://github.com/ikawrakow/ik_llama.cpp/issues/752) and this PR on other GPUs for the GPT-OSS models.

---

## ðŸ’¬ Conversation

ðŸ‘¤ **kirnat** commented on **2025-09-03** at **15:42:58**

Great improvement in TG on Blackwell.

## ggml/gpt-oss-20b-mxfp4
**Test Parameters:**
- Command: `llama-sweep-bench -m <model> -ngl 99 -ub 4096 -b 4096 -fa -fmoe -rtr -t 1`
- PP: 4096 tokens
- TG: 1024 tokens

| N_KV | **PR [#754](https://github.com/ikawrakow/ik_llama.cpp/issues/754)** | | | **PR [#752](https://github.com/ikawrakow/ik_llama.cpp/issues/752)** | | | **Î” Performance** | |
|------|---------|---------|---------|---------|---------|---------|---------|---------|
| | T_PP s | S_PP t/s | S_TG t/s | T_PP s | S_PP t/s | S_TG t/s | PP Î”% | TG Î”% |
| 0 | 0.216 | 18971.83 | 282.71 | 0.216 | 18962.79 | 277.62 | +0.0% | +1.8% |
| 4096 | 0.245 | 16693.09 | 265.57 | 0.248 | 16547.56 | 254.84 | +0.9% | +4.2% |
| 8192 | 0.294 | 13917.30 | 250.92 | 0.294 | 13921.60 | 235.33 | -0.0% | +6.6% |
| 12288 | 0.339 | 12065.44 | 236.70 | 0.338 | 12125.20 | 217.16 | -0.5% | +9.0% |
| 16384 | 0.387 | 10575.10 | 227.39 | 0.388 | 10567.81 | 209.12 | +0.1% | +8.7% |
| 20480 | 0.437 | 9383.73 | 216.31 | 0.435 | 9413.84 | 200.39 | -0.3% | +7.9% |
| 24576 | 0.484 | 8463.68 | 204.99 | 0.484 | 8457.46 | 190.29 | +0.1% | +7.7% |
| 28672 | 0.517 | 7923.52 | 195.25 | 0.530 | 7723.45 | 181.69 | +2.6% | +7.5% |
| 32768 | 0.559 | 7322.16 | 185.48 | 0.573 | 7147.71 | 173.43 | +2.4% | +6.9% |
| 36864 | 0.608 | 6737.53 | 174.80 | 0.619 | 6612.23 | 164.14 | +1.9% | +6.5% |
| 40960 | 0.679 | 6030.83 | 166.84 | 0.668 | 6133.18 | 156.64 | -1.7% | +6.5% |
| 45056 | 0.693 | 5908.14 | 158.23 | 0.694 | 5905.04 | 149.27 | +0.1% | +6.0% |
| 49152 | 0.745 | 5496.44 | 150.50 | 0.737 | 5558.86 | 141.72 | -1.1% | +6.2% |
| 53248 | 0.784 | 5225.36 | 144.75 | 0.784 | 5227.38 | 136.41 | -0.0% | +6.1% |
| 57344 | 0.836 | 4898.94 | 139.01 | 0.825 | 4963.05 | 131.33 | -1.3% | +5.8% |
| 61440 | 0.874 | 4687.16 | 133.22 | 0.871 | 4705.02 | 126.13 | -0.4% | +5.6% |
| 65536 | 0.922 | 4443.67 | 129.02 | 0.922 | 4444.11 | 122.20 | -0.0% | +5.6% |
| 69632 | 0.976 | 4198.52 | 124.62 | 0.966 | 4239.86 | 118.46 | -1.0% | +5.2% |
| 73728 | 1.014 | 4038.55 | 119.97 | 1.004 | 4080.30 | 114.24 | -1.0% | +5.0% |
| 77824 | 1.057 | 3876.62 | 115.94 | 1.052 | 3892.49 | 110.82 | -0.4% | +4.6% |
| 81920 | 1.106 | 3704.62 | 112.41 | 1.100 | 3724.27 | 107.63 | -0.5% | +4.4% |
| 86016 | 1.153 | 3551.12 | 108.57 | 1.137 | 3603.40 | 104.06 | -1.5% | +4.3% |
| 90112 | 1.191 | 3437.97 | 105.10 | 1.195 | 3428.42 | 100.77 | +0.3% | +4.3% |
| 94208 | 1.223 | 3348.05 | 102.41 | 1.225 | 3342.94 | 98.12 | +0.2% | +4.4% |
| 98304 | 1.273 | 3216.71 | 99.40 | 1.271 | 3221.64 | 95.49 | -0.2% | +4.1% |
| 102400 | 1.329 | 3082.39 | 96.41 | 1.301 | 3147.29 | 92.96 | -2.1% | +3.7% |
| 106496 | 1.404 | 2918.30 | 93.69 | 1.348 | 3039.16 | 90.34 | -4.0% | +3.7% |
| 110592 | 1.448 | 2829.23 | 90.69 | 1.392 | 2941.68 | 87.86 | -3.8% | +3.2% |
| 114688 | 1.489 | 2750.54 | 88.26 | 1.436 | 2852.46 | 86.06 | -3.6% | +2.6% |
| 118784 | 1.507 | 2718.05 | 86.70 | 1.493 | 2743.20 | 83.95 | -0.9% | +3.3% |
| 122880 | 1.542 | 2656.75 | 84.53 | 1.526 | 2683.75 | 81.70 | -1.0% | +3.5% |
| 126976 | 1.578 | 2595.17 | 82.50 | 1.576 | 2599.56 | 79.97 | -0.2% | +3.2% |

---

ðŸ‘¤ **ikawrakow** commented on **2025-09-04** at **06:39:29**

OK, [b02e137](https://github.com/ikawrakow/ik_llama.cpp/pull/754/commits/b02e137f604fe562b7132194fe82d5c87fc47408) further improves the TG performance, so this should be good to go now.

### GPT-OSS-20B-MXFP4

<img width="792" height="612" alt="u4_pp" src="https://github.com/user-attachments/assets/a868cd4c-5735-44a0-83a1-db0e99f54cc3" />

<img width="792" height="612" alt="u4_tg" src="https://github.com/user-attachments/assets/3f95f02d-c799-4cb8-8cae-5a808606e9f1" />

### Gemma3-12B-Q4_0

<img width="792" height="612" alt="u5_pp" src="https://github.com/user-attachments/assets/5a729204-9dcf-4cb1-a250-7145f2134085" />

<img width="792" height="612" alt="u5_tg" src="https://github.com/user-attachments/assets/79cf61d8-ffdb-438e-b2f7-e735e3491f34" />

<details>
<summary> GPT-OSS-20B-MXFP4, main branch</summary>

|    PP |     TG |   N_KV |   T_PP s | S_PP t/s |   T_TG s | S_TG t/s |
|-------|--------|--------|----------|----------|----------|----------|
|  2048 |    512 |      0 |    0.211 |  9686.10 |    2.913 |   175.74 |
|  2048 |    512 |   2048 |    0.228 |  8963.74 |    3.033 |   168.82 |
|  2048 |    512 |   4096 |    0.248 |  8263.56 |    3.154 |   162.33 |
|  2048 |    512 |   6144 |    0.273 |  7497.41 |    3.277 |   156.23 |
|  2048 |    512 |   8192 |    0.294 |  6959.12 |    3.366 |   152.11 |
|  2048 |    512 |  10240 |    0.319 |  6417.55 |    3.519 |   145.51 |
|  2048 |    512 |  12288 |    0.340 |  6029.95 |    3.600 |   142.22 |
|  2048 |    512 |  14336 |    0.365 |  5615.65 |    3.716 |   137.79 |
|  2048 |    512 |  16384 |    0.388 |  5283.58 |    3.820 |   134.04 |
|  2048 |    512 |  18432 |    0.407 |  5035.65 |    3.929 |   130.33 |
|  2048 |    512 |  20480 |    0.432 |  4736.61 |    4.045 |   126.58 |
|  2048 |    512 |  22528 |    0.455 |  4502.91 |    4.147 |   123.46 |
|  2048 |    512 |  24576 |    0.474 |  4324.80 |    4.284 |   119.53 |
|  2048 |    512 |  26624 |    0.495 |  4134.73 |    4.362 |   117.38 |
|  2048 |    512 |  28672 |    0.518 |  3956.36 |    4.473 |   114.48 |

</details>

<details>
<summary> GPT-OSS-20B-MXFP4, PR</summary>

|    PP |     TG |   N_KV |   T_PP s | S_PP t/s |   T_TG s | S_TG t/s |
|-------|--------|--------|----------|----------|----------|----------|
|  2048 |    512 |      0 |    0.205 | 10003.96 |    2.871 |   178.33 |
|  2048 |    512 |   2048 |    0.208 |  9826.36 |    2.964 |   172.75 |
|  2048 |    512 |   4096 |    0.230 |  8917.26 |    3.033 |   168.80 |
|  2048 |    512 |   6144 |    0.246 |  8330.35 |    3.122 |   164.01 |
|  2048 |    512 |   8192 |    0.263 |  7787.72 |    3.196 |   160.22 |
|  2048 |    512 |  10240 |    0.276 |  7409.15 |    3.274 |   156.40 |
|  2048 |    512 |  12288 |    0.292 |  7014.40 |    3.345 |   153.09 |
|  2048 |    512 |  14336 |    0.307 |  6661.16 |    3.412 |   150.08 |
|  2048 |    512 |  16384 |    0.322 |  6361.24 |    3.473 |   147.41 |
|  2048 |    512 |  18432 |    0.336 |  6102.96 |    3.543 |   144.53 |
|  2048 |    512 |  20480 |    0.351 |  5832.50 |    3.615 |   141.63 |
|  2048 |    512 |  22528 |    0.367 |  5586.18 |    3.685 |   138.95 |
|  2048 |    512 |  24576 |    0.381 |  5373.61 |    3.762 |   136.11 |
|  2048 |    512 |  26624 |    0.396 |  5174.20 |    3.833 |   133.59 |
|  2048 |    512 |  28672 |    0.410 |  4991.07 |    3.889 |   131.67 |

</details>

<details>
<summary>Gemma3-12B-Q4_0, main branch</summary>

|    PP |     TG |   N_KV |   T_PP s | S_PP t/s |   T_TG s | S_TG t/s |
|-------|--------|--------|----------|----------|----------|----------|
|  1024 |    256 |      0 |    0.189 |  5404.18 |    3.354 |    76.32 |
|  1024 |    256 |   1024 |    0.199 |  5157.00 |    3.464 |    73.91 |
|  1024 |    256 |   2048 |    0.208 |  4923.50 |    3.637 |    70.38 |
|  1024 |    256 |   3072 |    0.219 |  4675.33 |    3.818 |    67.05 |
|  1024 |    256 |   4096 |    0.228 |  4484.85 |    4.001 |    63.99 |
|  1024 |    256 |   5120 |    0.240 |  4261.52 |    4.226 |    60.57 |
|  1024 |    256 |   6144 |    0.252 |  4070.49 |    4.347 |    58.89 |
|  1024 |    256 |   7168 |    0.264 |  3883.17 |    4.510 |    56.76 |
|  1024 |    256 |   8192 |    0.274 |  3743.39 |    4.689 |    54.59 |
|  1024 |    256 |   9216 |    0.289 |  3544.88 |    4.838 |    52.92 |
|  1024 |    256 |  10240 |    0.301 |  3403.10 |    5.062 |    50.57 |
|  1024 |    256 |  11264 |    0.305 |  3361.54 |    5.169 |    49.53 |
|  1024 |    256 |  12288 |    0.321 |  3191.08 |    5.327 |    48.05 |
|  1024 |    256 |  13312 |    0.332 |  3083.16 |    5.490 |    46.63 |
|  1024 |    256 |  14336 |    0.342 |  2997.95 |    5.641 |    45.38 |
|  1024 |    256 |  15360 |    0.352 |  2911.57 |    5.841 |    43.83 |
|  1024 |    256 |  16384 |    0.367 |  2789.80 |    5.976 |    42.84 |

</details>

<details>
<summary>Gemma3-12B-Q4_0, PR</summary>

|    PP |     TG |   N_KV |   T_PP s | S_PP t/s |   T_TG s | S_TG t/s |
|-------|--------|--------|----------|----------|----------|----------|
|  1024 |    256 |      0 |    0.187 |  5470.67 |    3.280 |    78.04 |
|  1024 |    256 |   1024 |    0.193 |  5314.59 |    3.467 |    73.84 |
|  1024 |    256 |   2048 |    0.199 |  5135.90 |    3.489 |    73.37 |
|  1024 |    256 |   3072 |    0.203 |  5036.92 |    3.522 |    72.69 |
|  1024 |    256 |   4096 |    0.206 |  4965.88 |    3.557 |    71.97 |
|  1024 |    256 |   5120 |    0.211 |  4845.85 |    3.598 |    71.16 |
|  1024 |    256 |   6144 |    0.214 |  4783.88 |    3.624 |    70.64 |
|  1024 |    256 |   7168 |    0.219 |  4684.27 |    3.673 |    69.69 |
|  1024 |    256 |   8192 |    0.222 |  4605.17 |    3.695 |    69.28 |
|  1024 |    256 |   9216 |    0.232 |  4414.36 |    3.730 |    68.63 |
|  1024 |    256 |  10240 |    0.236 |  4336.89 |    3.762 |    68.05 |
|  1024 |    256 |  11264 |    0.233 |  4394.94 |    3.794 |    67.48 |
|  1024 |    256 |  12288 |    0.239 |  4279.17 |    3.840 |    66.67 |
|  1024 |    256 |  13312 |    0.243 |  4216.53 |    3.865 |    66.23 |
|  1024 |    256 |  14336 |    0.250 |  4094.53 |    3.896 |    65.70 |
|  1024 |    256 |  15360 |    0.253 |  4050.31 |    3.933 |    65.09 |
|  1024 |    256 |  16384 |    0.257 |  3985.02 |    3.965 |    64.57 |

</details>