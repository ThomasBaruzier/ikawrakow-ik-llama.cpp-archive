## ðŸ”€ [Pull Request #899](https://github.com/ikawrakow/ik_llama.cpp/pull/899) - Much better CPU TG performance at long context for GLM-4.5

| **Author** | `ikawrakow` |
| :--- | :--- |
| **State** | ðŸ”€ **Merged** |
| **Source Branch** | `ik/cpu_fa_tg_glm4.5` |
| **Target Branch** | `main` |
| **Created** | 2025-11-04 |
| **Updated** | 2025-11-05 |
| **Merged** | 2025-11-05 |

---

## ðŸ“„ Description

This PR massively improves CPU-only long context TG performance for the GLM-4.5/6 model series.

GLM-4.5/4.6 is one of the most popular models these days. It has a somewhat unusual GQA ratio of 12. This results in difficulties to efficiently perform the self attention computation (on the CPU and the GPU). This PR solves the problem for TG on the CPU when using flash attention with quantized K-cache.

Here are some results for Unsloth's GLM-4.5-AIR `IQ2_XXS` model on a Ryzen-7950X CPU. Command was
```
./bin/llama-sweep-bench -m GLM-4.5-Air-UD-IQ2_XXS.gguf -t 16 -c 16384 -ub 1024 -ctk q8_0
```
At a context of 16k tokens, TG performance with this PR is 1.62X better than the main branch, and 2.25X better than `llama.cpp`.

I'm only plotting TG performance as `llama.cpp's` PP performance is embarrassing (but the curious can see in the details below the graph).

<img width="792" height="612" alt="x14" src="https://github.com/user-attachments/assets/d391a579-2397-431d-b89b-ac21fbdb8c2d" />


<details>
<summary>Main branch</summary>

|    PP |     TG |   N_KV |   T_PP s | S_PP t/s |   T_TG s | S_TG t/s |
|-------|--------|--------|----------|----------|----------|----------|
|  1024 |    256 |      0 |    7.246 |   141.32 |   28.493 |     8.98 |
|  1024 |    256 |   1024 |    7.913 |   129.41 |   29.908 |     8.56 |
|  1024 |    256 |   2048 |    8.905 |   114.99 |   31.366 |     8.16 |
|  1024 |    256 |   3072 |    9.649 |   106.13 |   32.718 |     7.82 |
|  1024 |    256 |   4096 |   10.863 |    94.26 |   34.651 |     7.39 |
|  1024 |    256 |   5120 |   12.250 |    83.59 |   36.441 |     7.02 |
|  1024 |    256 |   6144 |   13.244 |    77.32 |   38.693 |     6.62 |
|  1024 |    256 |   7168 |   13.672 |    74.90 |   39.800 |     6.43 |
|  1024 |    256 |   8192 |   14.967 |    68.42 |   44.629 |     5.74 |
|  1024 |    256 |   9216 |   15.704 |    65.21 |   48.234 |     5.31 |
|  1024 |    256 |  10240 |   16.798 |    60.96 |   50.313 |     5.09 |
|  1024 |    256 |  11264 |   17.776 |    57.60 |   54.754 |     4.68 |
|  1024 |    256 |  12288 |   18.284 |    56.00 |   53.365 |     4.80 |
|  1024 |    256 |  13312 |   19.283 |    53.10 |   61.060 |     4.19 |
|  1024 |    256 |  14336 |   20.791 |    49.25 |   64.888 |     3.95 |
|  1024 |    256 |  15360 |   21.573 |    47.47 |   68.538 |     3.74 |

</details>

<details>
<summary>This PR</summary>

|    PP |     TG |   N_KV |   T_PP s | S_PP t/s |   T_TG s | S_TG t/s |
|-------|--------|--------|----------|----------|----------|----------|
|  1024 |    256 |      0 |    7.090 |   144.43 |   28.428 |     9.01 |
|  1024 |    256 |   1024 |    7.880 |   129.95 |   29.578 |     8.66 |
|  1024 |    256 |   2048 |    8.822 |   116.07 |   30.649 |     8.35 |
|  1024 |    256 |   3072 |    9.610 |   106.56 |   31.593 |     8.10 |
|  1024 |    256 |   4096 |   10.896 |    93.98 |   32.316 |     7.92 |
|  1024 |    256 |   5120 |   11.767 |    87.02 |   33.028 |     7.75 |
|  1024 |    256 |   6144 |   12.610 |    81.21 |   33.895 |     7.55 |
|  1024 |    256 |   7168 |   13.675 |    74.88 |   34.533 |     7.41 |
|  1024 |    256 |   8192 |   14.850 |    68.95 |   35.837 |     7.14 |
|  1024 |    256 |   9216 |   15.696 |    65.24 |   35.940 |     7.12 |
|  1024 |    256 |  10240 |   16.681 |    61.39 |   37.190 |     6.88 |
|  1024 |    256 |  11264 |   17.607 |    58.16 |   38.282 |     6.69 |
|  1024 |    256 |  12288 |   18.474 |    55.43 |   39.817 |     6.43 |
|  1024 |    256 |  13312 |   19.427 |    52.71 |   39.526 |     6.48 |
|  1024 |    256 |  14336 |   20.466 |    50.03 |   41.154 |     6.22 |
|  1024 |    256 |  15360 |   21.400 |    47.85 |   42.321 |     6.05 |

</details>

<details>
<summary>llama.cpp</summary>

|    PP |     TG |   N_KV |   T_PP s | S_PP t/s |   T_TG s | S_TG t/s |
|-------|--------|--------|----------|----------|----------|----------|
|  1024 |    256 |      0 |   34.227 |    29.92 |   32.888 |     7.78 |
|  1024 |    256 |   1024 |   41.534 |    24.65 |   33.989 |     7.53 |
|  1024 |    256 |   2048 |   50.583 |    20.24 |   37.855 |     6.76 |
|  1024 |    256 |   3072 |   59.029 |    17.35 |   42.138 |     6.08 |
|  1024 |    256 |   4096 |   67.494 |    15.17 |   45.587 |     5.62 |
|  1024 |    256 |   5120 |   76.440 |    13.40 |   49.999 |     5.12 |
|  1024 |    256 |   6144 |   85.411 |    11.99 |   54.364 |     4.71 |
|  1024 |    256 |   7168 |   93.718 |    10.93 |   58.263 |     4.39 |
|  1024 |    256 |   8192 |  102.585 |     9.98 |   61.221 |     4.18 |
|  1024 |    256 |   9216 |  110.084 |     9.30 |   66.558 |     3.85 |
|  1024 |    256 |  10240 |  118.418 |     8.65 |   70.352 |     3.64 |
|  1024 |    256 |  11264 |  127.666 |     8.02 |   73.900 |     3.46 |
|  1024 |    256 |  12288 |  137.941 |     7.42 |   77.856 |     3.29 |
|  1024 |    256 |  13312 |  149.083 |     6.87 |   83.190 |     3.08 |
|  1024 |    256 |  14336 |  164.657 |     6.22 |   88.863 |     2.88 |
|  1024 |    256 |  15360 |  180.993 |     5.66 |   95.342 |     2.69 |

</details>